<!DOCTYPE html>
<html>
<head>
  <title>Speech Recognition</title>
</head>
<body>
  <h1>Speech Recognition Example</h1>
  <button id="startButton">Start</button>
  <p id="status"></p>
  <audio id="audio" controls></audio>


  <form id="transcriptForm" action="/process" method="post">
    <label for="transcript">Transcript:</label><br>
    <textarea id="transcript" name="transcript" rows="4" cols="50"></textarea><br>
  </form>


  <script>
    const startButton = document.getElementById("startButton");
    const status = document.getElementById("status");
    const audio = document.getElementById("audio");

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();
    recognition.lang = 'en-US';

    let chunks = [];

    startButton.addEventListener('click', () => {
      chunks = [];
      recognition.start();
      status.textContent = "Listening...";
    });

    recognition.onaudiostart = () => {
      status.textContent = "Recording...";
    };

    recognition.onaudioend = () => {
      status.textContent = "Processing...";
      recognition.stop();
    };

    recognition.onnomatch = () => {
      status.textContent = "No speech recognized";
    };

    recognition.onerror = (event) => {
      console.error(event.error);
      status.textContent = "Error: " + event.error;
    };

    recognition.onresult = (event) => {
      const result = event.results[0][0].transcript;
      status.textContent = "Finished: " + result;
      audio.controls = true;

      const audioBlob = new Blob(chunks, { type: 'audio/webm' });
      const audioUrl = URL.createObjectURL(audioBlob);
      audio.src = audioUrl;

      const transcriptElement = document.getElementById("transcript");
      transcriptElement.textContent = result;

      // Automatically submit the form
      const form = document.getElementById("transcriptForm");
      form.submit();

      // recognition.stop();
      // sendTranscript(result);
    };

    recognition.ondataavailable = (event) => {
      chunks.push(event.data);
    };

    function sendTranscript(transcript) {
      fetch('/process', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ transcript: transcript })
      })
        .then(response => response.text())
        .then(data => {
          console.log('Server response:', data);
          // Do something with the server response
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }
  </script>
</body>
</html>
